#!/usr/bin/make -f
# debian/rules for WvStreams, using debhelper.
#
# Based on the sample debian/rules under GNU copyright 1997 to 1999 by
# Joey Hess, with revisions by Bill Allombert in 2001.

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

# This has to be exported to make some magic below work.
export DH_OPTIONS

# Don't rebuild the configure script
export WE_ARE_DIST=1

# These are used for cross-compiling and for saving the configure script
# from having to guess our platform (since we know it already)
DEB_HOST_GNU_TYPE   ?= $(shell dpkg-architecture -qDEB_HOST_GNU_TYPE)
DEB_BUILD_GNU_TYPE  ?= $(shell dpkg-architecture -qDEB_BUILD_GNU_TYPE)

version:=$(shell awk -F= '/SO_VERSION=/{print $$2}' $(CURDIR)/configure.ac)
base=libwvstreams$(version)
# This is used the wvstreams makefile to set the .so links
PKG=$(CURDIR)/debian/${base}
PKG_QT=$(CURDIR)/debian/${base}-qt
PKGDEV=$(CURDIR)/debian/libwvstreams-dev
PKGDOC=$(CURDIR)/debian/${base}-doc
DOCDIR=$(PKGDOC)/usr/share/doc/$(base)-doc

CFLAGS = -Wall

ifneq (,$(findstring debug,$(DEB_BUILD_OPTIONS)))
	CFLAGS += -g
endif
ifneq (,$(findstring noopt,$(DEB_BUILD_OPTIONS)))
	CFLAGS += -O0
else
	CFLAGS += -O2
endif
ifeq (,$(findstring nostrip,$(DEB_BUILD_OPTIONS)))
	INSTALL_PROGRAM += -s
endif

config.status: configure
	dh_testdir
	# Add here commands to configure the package.
	CFLAGS="$(CFLAGS)" ./configure \
		--host=$(DEB_HOST_GNU_TYPE) --build=$(DEB_BUILD_GNU_TYPE) \
		--prefix=/usr --mandir=\$${prefix}/share/man \
		--infodir=\$${prefix}/share/info \
		--sysconfdir=/etc --localstatedir=/var \
		--disable-debug --disable-verbose \
		--with-qt --with-openslp


#Architecture
build: build-arch build-indep

build-arch: build-arch-stamp
build-arch-stamp: config.status

	# Add here commands to compile the arch part of the package.
	$(MAKE) VERBOSE=1 CXXOPTS="-fPIC -DPIC" COPTS="-fPIC -DPIC"
	$(MAKE) VERBOSE=1 CXXOPTS="-fPIC -DPIC" COPTS="-fPIC -DPIC" uniconf/tests/uni
	touch build-arch-stamp

build-indep: build-stamp-indep
build-stamp-indep: config.status

	# Add here commands to compile the indep part of the package.
	#$(MAKE) doc
	$(MAKE) doxygen
	@# Don't build the SGML documentation, as it is uncompilable.
	@#$(MAKE) -C Docs/sgmlmanual html ps pdf
	touch build-stamp-indep

clean:
	dh_testdir
	dh_testroot
	rm -f build-stamp build-stamp-indep #CONFIGURE-STAMP#

	# Add here commands to clean up after the build process.
	-$(MAKE) -C Docs/sgmlmanual clean
	-rm -rf Docs/doxy-html
	-$(MAKE) -C xplc distclean
	-$(MAKE) distclean

ifneq "$(wildcard /usr/share/misc/config.sub)" ""
	cp -f /usr/share/misc/config.sub config.sub
endif
ifneq "$(wildcard /usr/share/misc/config.guess)" ""
	cp -f /usr/share/misc/config.guess config.guess
endif

	dh_clean

install: install-indep install-arch
install-indep:
	dh_testdir
	dh_testroot
	dh_clean -k -i
	dh_installdirs -i

	# Add here commands to install the indep part of the package into
	# debian/<package>-doc.
	#INSTALLDOC#
	install -d $(DOCDIR)
	install -d $(DOCDIR)/html-api
	find Docs/doxy-html -type f -exec install -m644 '{}' $(DOCDIR)/html-api/ ';'

#	@# Don't install the SGML documentation.
#	@install -d $(DOCDIR)/html-manual
#	@install -m644 Docs/sgmlmanual/wvstreams.html/*.html \
#		$(DOCDIR)/html-manual/
#	@install -m644 Docs/sgmlmanual/wvstreams.ps \
#		Docs/sgmlmanual/wvstreams.pdf \
#		$(DOCDIR)

	dh_install -i

install-arch:
	dh_testdir
	dh_testroot
	dh_clean -k -s
	dh_installdirs -s

	# Add here commands to install the arch part of the package into
	# debian/tmp.
	#$(MAKE) install prefix=$(CURDIR)/debian/wvstreams/usr

	# Install library package

#	$(MAKE) installshared PREFIX=$(PKG)/usr
	# Temporary Fix to work around a bug in Debhelper
	$(MAKE) install-shared DESTDIR=$(CURDIR)/debian/tmp

	# Install development package
	$(MAKE) install-dev DESTDIR=$(PKGDEV)

	# Install a minimal XPLC
	$(MAKE) install-xplc DESTDIR=$(PKGDEV)
	rm -f $(PKGDEV)/usr/lib/libxplc.so*

	# Install UniConf daemon
	$(MAKE) install-uniconfd DESTDIR=$(CURDIR)/debian/tmp
	install -d $(CURDIR)/debian/tmp/etc/default
	install -m644 debian/uniconfd.default debian/tmp/etc/default/uniconfd

	# Install lintian overrides
	install -m644 debian/libwvstreams$(version)-base.lintian-override debian/libwvstreams$(version)-base/usr/share/lintian/overrides/libwvstreams$(version)-base
	install -m644 debian/libwvstreams$(version)-extras.lintian-override debian/libwvstreams$(version)-extras/usr/share/lintian/overrides/libwvstreams$(version)-extras
	install -m644 debian/libwvstreams$(version)-qt.lintian-override debian/libwvstreams$(version)-qt/usr/share/lintian/overrides/libwvstreams$(version)-qt

	dh_install -s

# Must not depend on anything. This is to be called by
# binary-arch/binary-indep
# in another 'make' thread.
binary-common:
	dh_testdir
	dh_testroot
	dh_installchangelogs ChangeLog
	dh_installdocs
	dh_installexamples
#       dh_installmenu
#       dh_installdebconf
#       dh_installlogrotate
#       dh_installemacsen
#       dh_installpam
#       dh_installmime
	dh_installinit
#       dh_installcron
#       dh_installinfo
	dh_installman
	dh_link
	dh_strip --exclude=libwvtest.a
	dh_compress
	dh_fixperms
#       dh_perl
#       dh_python
	dh_makeshlibs -plibwvstreams$(version)-base \
		      -plibwvstreams$(version)-extras \
		      -plibwvstreams$(version)-qt \
		      -plibuniconf$(version) \
	dh_installdeb
	dh_installdeb
	dh_shlibdeps -L libwvstreams$(version)-base \
		     -L libwvstreams$(version)-extras \
		     -L libuniconf$(version) \
		     -l debian/libwvstreams$(version)-base/usr/lib:debian/libwvstreams$(version)-extras/usr/lib:debian/libuniconf$(version)/usr/lib
	dh_gencontrol
	dh_md5sums
	dh_builddeb
# Build architecture independant packages using the common target.
binary-indep: build-indep install-indep
	$(MAKE) -f debian/rules DH_OPTIONS=-i binary-common

# Build architecture dependant packages using the common target.
binary-arch: build-arch install-arch
	$(MAKE) -f debian/rules DH_OPTIONS=-a binary-common

binary: binary-arch binary-indep
.PHONY: build clean binary-indep binary-arch binary install install-indep install-arch
